<script>
const form = document.getElementById("noteForm");
const notesList = document.getElementById("notesList");
const searchBar = document.getElementById("searchBar");
const previewSection = document.getElementById("previewSection");
const previewFrame = document.getElementById("previewFrame");
const dropArea = document.getElementById("dropArea");
const fileInput = document.getElementById("file");
const departmentSelect = document.getElementById("department");
const subjectInput = document.getElementById("subject");
const filterDepartment = document.getElementById("filterDepartment");
const selectedFileDiv = document.getElementById("selectedFile");

let notes = JSON.parse(localStorage.getItem("notes")) || [];
renderNotes();

dropArea.addEventListener("click", ()=>fileInput.click());
dropArea.addEventListener("dragover", e=>{ e.preventDefault(); dropArea.style.backgroundColor="#f0f8ff"; });
dropArea.addEventListener("dragleave", e=>{ e.preventDefault(); dropArea.style.backgroundColor="transparent"; });
dropArea.addEventListener("drop", e=>{
  e.preventDefault();
  fileInput.files = e.dataTransfer.files;
  dropArea.style.backgroundColor="transparent";
  if(fileInput.files.length>0){ selectedFileDiv.innerText=`File Selected: ${fileInput.files[0].name}`; }
});
fileInput.addEventListener("change", ()=>{ if(fileInput.files.length>0){ selectedFileDiv.innerText=`File Selected: ${fileInput.files[0].name}`; } });

form.addEventListener("submit", e=>{
  e.preventDefault();
  const file = fileInput.files[0];
  if(!file){ 
    alert("⚠️ Please select a file!"); 
    return; 
  }

  // ✅ File type check (allow only PDF, JPG, PNG)
  const allowedTypes = ["application/pdf", "image/png", "image/jpeg"];
  if(!allowedTypes.includes(file.type)){
    alert("⚠️ Only PDF, PNG, and JPG files are allowed!");
    return;
  }

  // ✅ File size check (max 5 MB)
  if(file.size > 5 * 1024 * 1024){
    alert("⚠️ File too large! Please upload files under 5 MB.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function(event){
    const note = {
      department: departmentSelect.value,
      subject: subjectInput.value,
      semester: document.getElementById("semester").value,
      fileName: file.name,
      fileData: event.target.result,
      fileType: file.type
    };
    notes.push(note);
    localStorage.setItem("notes", JSON.stringify(notes));
    renderNotes();
    selectedFileDiv.innerText = `Uploaded: ${file.name}`;
    subjectInput.value=""; fileInput.value="";
  };
  reader.readAsDataURL(file);
});

function renderNotes(filterText=""){
  const selectedDept = filterDepartment.value;
  notesList.innerHTML="";
  notes.forEach((note,index)=>{
    const matchesFilterText = note.subject.toLowerCase().includes(filterText.toLowerCase()) || note.fileName.toLowerCase().includes(filterText.toLowerCase()) || note.semester.includes(filterText);
    const matchesDepartment = selectedDept==="" || note.department===selectedDept;
    if(matchesFilterText && matchesDepartment){
      let li=document.createElement("li");
      let link=document.createElement("span");
      link.innerText=`[${note.department}] ${note.subject} (Sem ${note.semester}) - ${note.fileName}`;
      
      let previewBtn=document.createElement("button");
      previewBtn.innerText="Preview"; 
      previewBtn.classList.add("previewBtn");
      previewBtn.onclick=function(){ 
        if(note.fileType==="application/pdf"){
          previewFrame.src=note.fileData; 
          previewSection.style.display="block"; 
          previewSection.scrollIntoView({behavior:"smooth"}); 
        }else if(note.fileType.startsWith("image/")){
          previewFrame.src=note.fileData;
          previewSection.style.display="block"; 
          previewSection.scrollIntoView({behavior:"smooth"});
        }else{ 
          alert("⚠️ Preview only works for PDF or images!"); 
        }
      };

      let downloadBtn=document.createElement("button");
      downloadBtn.innerText="Download"; 
      downloadBtn.classList.add("downloadBtn");
      downloadBtn.onclick=function(){ 
        // Detect if running inside WebView (APK) or normal browser
        if(window.navigator.userAgent.includes("wv")){ 
          window.open(note.fileData, "_blank");
        } else { 
          const a=document.createElement("a"); 
          a.href=note.fileData; 
          a.download=note.fileName; 
          a.click(); 
        }
      };

      let delBtn=document.createElement("button");
      delBtn.innerText="Delete"; 
      delBtn.classList.add("deleteBtn");
      delBtn.onclick=function(){ 
        notes.splice(index,1); 
        localStorage.setItem("notes", JSON.stringify(notes)); 
        renderNotes(searchBar.value); 
        previewSection.style.display="none"; 
      };

      li.appendChild(link); 
      li.appendChild(previewBtn); 
      li.appendChild(downloadBtn); 
      li.appendChild(delBtn);
      notesList.appendChild(li);
    }
  });
}

searchBar.addEventListener("input", ()=>renderNotes(searchBar.value));
filterDepartment.addEventListener("change", ()=>renderNotes(searchBar.value));

function showSection(id){
  document.querySelectorAll("section").forEach(sec=>sec.style.display="none");
  const section=document.getElementById(id);
  if(section){ section.style.display="block"; section.scrollIntoView({behavior:"smooth"}); }
}

// Default visible section
window.addEventListener("DOMContentLoaded", ()=>{ showSection('uploadSection'); });

// Reviews
const reviewForm=document.getElementById("reviewForm");
const reviewText=document.getElementById("reviewText");
const reviewsList=document.getElementById("reviewsList");
let reviews=JSON.parse(localStorage.getItem("reviews")) || [];
function renderReviews(){ 
  reviewsList.innerHTML=""; 
  reviews.forEach(r=>{ 
    let li=document.createElement("li"); 
    li.classList.add("reviewItem"); 
    li.innerText=r; 
    reviewsList.appendChild(li); 
  }); 
}
renderReviews();
reviewForm.addEventListener("submit", e=>{ 
  e.preventDefault(); 
  reviews.push(reviewText.value); 
  localStorage.setItem("reviews", JSON.stringify(reviews)); 
  reviewText.value=""; 
  renderReviews(); 
});
    </script>      
